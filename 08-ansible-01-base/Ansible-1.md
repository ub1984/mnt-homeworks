## Ansible основы 


Control node - это сервер, с которого осуществляется управление и запуск автоматизированных задач с использованием Ansible.

Managed node - это компьютер или устройство, которое управляется и конфигурируется с использованием Ansible с помощью управляющего узла (control node).

Inventory - это файл или источник данных, содержащий информацию об управляемых узлах (managed nodes), которые Ansible должен управлять, 
такие как их IP-адреса, имена хостов, группировки и переменные хостов.

Playbook - это файл YAML-формата, в котором описываются шаги и задачи, которые Ansible должен выполнить на управляемых узлах (managed nodes) в рамках автоматизированной операции.

Play - это основной компонент Ansible playbook, описывающий серию задач, которые нужно выполнить на одной или нескольких группах хостов (hosts).

Role - это структура организации кода в Ansible, предназначенная для повторного использования и модульности. 
Роль объединяет задачи, переменные, шаблоны и другие ресурсы в единое целое для упрощения управления конфигурацией и автоматизации процессов.

Task - это основная единица работы в Ansible, определяющая конкретное действие, которое необходимо выполнить на управляемых узлах. 
Каждая задача включает в себя одно или несколько действий, таких как установка пакета, копирование файлов или выполнение команды в консоли.

Handlers - это действия в Ansible, которые выполняются только при наличии определенных условий, например, при изменении состояния управляемых узлов после выполнения задач. 
Обычно они используются для перезапуска сервисов или выполнения других операций, зависящих от изменений, которые были внесены.

Inventory - это файл или источник данных, который содержит информацию об управляемых узлах (managed nodes), доступных для управления с использованием Ansible. 
В инвентаре указываются IP-адреса, имена хостов, группировки хостов и другие параметры, которые помогают Ansible определить, куда и какие задачи выполнять.

Group vars - это механизм в Ansible, позволяющий определять переменные, специфичные для группы хостов в инвентаре. 
Эти переменные применяются ко всем хостам в указанной группе и используются для настройки и конфигурирования задач, выполняемых на этих узлах.

Facts - это данные о системе, которые собираются Ansible при выполнении задач на управляемых узлах. 
Эти данные могут включать информацию о версии операционной системы, аппаратном обеспечении, сетевых настройках и других аспектах системы. 
Facts могут использоваться для принятия решений и настройки задач в зависимости от окружения управляемых узлов.

Templates - это файлы, содержащие разметку в формате Jinja2, которая позволяет создавать динамические конфигурационные файлы, скрипты и другие текстовые файлы в Ansible. 
Шаблоны позволяют использовать переменные, условные операторы, циклы и другие конструкции для генерации конфигураций, адаптированных к конкретным хостам или условиям выполнения задач.

Collections - это средство организации и переиспользования контента Ansible, такого как роли, плагины, модули, инвентари и дополнения. 
Они объединяют связанные ресурсы в единый пакет для удобного распространения, управления и использования в различных проектах и средах.

Установка  Ansible

Для установки Ansible используйте следующую команду:

    sudo apt update
    sudo apt install software-properties-common
    sudo add-apt-repository --yes --update ppa:ansible/ansible
    sudo apt install ansible

Пакет установки -

### Ansible
| Команда             | Назначение                                        | Пример использования                                     |
|---------------------|---------------------------------------------------|---------------------------------------------------------|
| Ansible-playbook    | Автоматизация конфигурации и развертывания.     | `ansible-playbook playbook.yml`                          |
| Ansible-vault       | Шифрование конфиденциальных данных в Ansible.    | `ansible-vault encrypt secret.yml`                       |
| ansible-galaxy      | Хранилище ролей и коллекций Ansible.            | `ansible-galaxy install username.role_name`             |
| ansible-lint        | Проверка стиля и синтаксиса Ansible.            | `ansible-lint playbook.yml`                              |
| ansible-console     | Интерактивная консоль для управления Ansible.   | `ansible-console`                                        |
| ansible-config      | Управление настройками Ansible.                 | `ansible-config view`                                    |
| ansible-doc         | Документация Ansible.                           | `ansible-doc command`                                    |
| ansible-Inventory   | Управление списком узлов в Ansible.            | `ansible-inventory --list`                               |
| ansible-pull        | Выполнение Ansible-кода на удаленных узлах.    | `ansible-pull -U git_repo playbook.yml`                  |
| ansible-test        | Тестирование ролей и плейбуков Ansible.        | `ansible-test integration docker -v`                     |

Первые пробы - 
ansible --version
ansible -m ping localhost #ожидаем pong

### первый playbook

    site.yml

    name: First play            # Название плейбука.
    hosts: all                  # Применение ко всем управляемым узлам.
    gather_facts: false         # Отключение сбора фактов.
    Tasks:                      # Начало описания задач.
        -name: Print one        # Название задачи.
        debug:
          var: custom var       # Отладочная задача для вывода переменной.
        -name: Print two
          msg: Hello-world!!!

в директории inventory распологаем hosts.yml

    hosts.yml

    prod:                               # Название группы узлов
      hosts:                            # Определение списка узлов
        centos7:                        # Имя узла "centos7"
          ansible_host: localhost       # IP-адрес или имя хоста для соединения Ansible
          ansible_connection: local     # Тип соединения - локальное выполнение
        localhost:                      # Узел "localhost"
          ansible_connection: local     # Тип соединения - локальное выполнение
        ubuntu:                         # Имя узла "ubuntu"
          ansible_connection: local     # Тип соединения - локальное выполнение
          ansible_host: localhost       # IP-адрес или имя хоста для соединения Ansible

выполнение > ansible-playbook -i inventory/hosts.yml site.yml 


##### Статусы узлов в Ansible могут быть следующими:

    reachable (доступен): Узел доступен для выполнения задач.

    unreachable (недоступен): Не удалось установить соединение с узлом.

    failed (не выполнено): Задача не выполнена на узле из-за ошибки.

    changed (изменено): Задача была выполнена и внесла изменения на узле.

    ok (в порядке): Задача успешно выполнена на узле без изменений.

    skipped (пропущено): Задача была пропущена из-за условия или флага.

    rescued (восстановлен): Задача была выполнена с ошибкой, но после этого была успешно исправлена Ansible.

    ignored (проигнорирован): Узел был проигнорирован из-за настроек или условий, не подходящих для выполнения задачи.

### Inventory - это файл или источник данных, который содержит информацию об управляемых узлах

> ansible-inventory -i inventory/hosts.yml --graph # возвращает графическое представление структуры инвентаря, описанного в файле.
> ansible-inventory -i inventory/hosts.yml --list  # возвращает список узлов и их атрибутов, описанных в инвентаре, который находится в файле.
> ansible-inventory -i inventory/hosts.yml --host ubuntu # возвращает информацию о заданном хосте, определенном в инвентаре, который находится в файле.

### Group vars - это механизм в Ansible, позволяющий определять переменные, специфичные для группы хостов в инвентаре.

>Хранятся в директории Group_vars
    Определение переменных для всех хостов проиходит в директории all
    Определение переменных для групп из inventory в соответствующих им директориях
    Файлы с переменными могут называться, основываясь на внутринней логике playbook, имена важны пользователям.


### Facts - это данные о системе, которые собираются Ansible при выполнении задач на управляемых узлах.

> Можно собирать данные об одном хосте и использовать для настройки других
Собираются автоматически при использовании Play
пример > ansible <hostname> -m setupe 
Хранятся в переменной ansible_facts
Можно отключить сбор фактов play gather_facts: false

### Приоритезация переменных
>1 - Экстраагрументы из командной строке с ключем -e (-e "user=xxx")
2 - значение переменных role из vars
3 - переменные из play
4 - Group_vars/{groupname}
5 - Group_vars/all
6 - inventory
7 - roles
8 - значение из командной строки (-u username)


### Vault -  механизм шифрования для конфиденциальных данных, таких как пароли, ключи и другая чувствительная информация
>пример:
>нужно зашифровать  custom.yml
>>ansible_vault encrypt Group_vars/prod/custom.yml
запросит придумать пароль от хранилища

ansible может использовать зашифрованые файлы
>ansible-playbook -i inventory/hosts.yml site.yml --ask-vault-pass 
запросит пароль от волта
файл он не дишефрует а просто его использует

Расшифровка файла
>ansible-vault decrypt Group_vars/prod/custom.yml
запросит пароль от этого файла

редактирование и просмотр файла без дишифрации

>ansible-vault view Group_vars/prod/custom.yml
запросит пароль от файла
вывидет в консоль значение файла

>ansible-vault edit Group_vars/prod/custom.yml
редактор в консоли

Зашифровать отдельную строку
>ansible-vault encrypt_string Group_vars/prod/custom.yml
просит ввести значение которое будет зашифровано 
нажимаем дважды Ctrl+D 
и вставляем в нужное место в файле


### Templates - это файлы, содержащие разметку в формате Jinja2, которая позволяет создавать динамические конфигурационные файлы, скрипты и другие текстовые файлы в Ansible.

- Любой конфигурационный файл может быть использован
- Шаблон должен иметь расширение J2 
> Пример
"Привет" {name}!.format(name="Мир")

пример использования hw.yml

    ---
    - name: Пример использования Jinja2
    hosts: localhost
    tasks:
        - name: Печать "Hello, World!"
        debug:
            msg: "{{ lookup('template', 'hello.j2') }}"

ansible-playbook hw.yml

#### Collections -  представляют собой пакеты, которые содержат роли, плагины, модули, инвентари и другие ресурсы, предназначенные для повторного использования и расширения функциональности Ansible. Коллекции представляют собой организованный и управляемый способ распространения и обмена кодом и компонентами Ansible.

название состоит из namespace.Collections - netology.sample
> ansible-galaxy collection init netology.sample

